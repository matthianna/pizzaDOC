generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                String  @id
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  users             users   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id
  sessionToken String   @unique
  userId       String
  expires      DateTime
  users        users    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model SystemSettings {
  id          String   @id
  key         String   @unique
  value       String
  description String?
  updatedAt   DateTime
  createdAt   DateTime @default(now())
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model absences {
  id                               String   @id
  userId                           String
  startDate                        DateTime
  endDate                          DateTime
  reason                           String?
  createdAt                        DateTime @default(now())
  updatedAt                        DateTime
  notes                            String?
  approved                         Boolean  @default(false)
  approvedBy                       String?
  users_absences_approvedByTousers users?   @relation("absences_approvedByTousers", fields: [approvedBy], references: [id])
  users_absences_userIdTousers     users    @relation("absences_userIdTousers", fields: [userId], references: [id], onDelete: Cascade)
}

model advances {
  id        String   @id
  userId    String
  amount    Float
  date      DateTime
  notes     String?
  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime
  users     users    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model audit_logs {
  id           String          @id
  userId       String
  userUsername String
  action       AuditActionType
  description  String
  ipAddress    String?
  userAgent    String?
  metadata     Json?
  createdAt    DateTime        @default(now())
  users        users           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([action])
  @@index([createdAt])
  @@index([userId])
}

model availabilities {
  id           String    @id
  userId       String
  weekStart    DateTime
  dayOfWeek    Int
  shiftType    ShiftType
  isAvailable  Boolean   @default(false)
  isAbsentWeek Boolean   @default(false)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime
  users        users     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, weekStart, dayOfWeek, shiftType])
}

model schedules {
  id        String   @id
  weekStart DateTime @unique
  createdAt DateTime @default(now())
  updatedAt DateTime
  shifts    shifts[]
}

model shift_limits {
  id            String    @id
  dayOfWeek     Int
  shiftType     ShiftType
  role          Role
  createdAt     DateTime  @default(now())
  updatedAt     DateTime
  requiredStaff Int       @default(1)

  @@unique([dayOfWeek, shiftType, role])
}

model shift_start_time_distributions {
  id          String    @id
  shiftType   ShiftType
  role        Role
  startTime   String
  targetCount Int
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime
  dayOfWeek   Int       @default(0)

  @@unique([dayOfWeek, shiftType, role, startTime])
}

model shift_start_time_templates {
  id          String    @id
  shiftType   ShiftType
  role        Role
  startTime   String
  priority    Int       @default(0)
  isActive    Boolean   @default(true)
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime
}

model shifts {
  id            String          @id
  scheduleId    String
  userId        String
  dayOfWeek     Int
  shiftType     ShiftType
  role          Role
  status        ShiftStatus     @default(ASSIGNED)
  startTime     String
  endTime       String
  createdAt     DateTime        @default(now())
  updatedAt     DateTime
  schedules     schedules       @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  users         users           @relation(fields: [userId], references: [id], onDelete: Cascade)
  substitutions substitutions[]
  worked_hours  worked_hours?
}

model substitutions {
  id                                      String             @id
  shiftId                                 String
  requesterId                             String
  substituteId                            String?
  approverId                              String?
  status                                  SubstitutionStatus @default(PENDING)
  requestNote                             String?
  responseNote                            String?
  deadline                                DateTime
  createdAt                               DateTime           @default(now())
  updatedAt                               DateTime
  users_substitutions_approverIdTousers   users?             @relation("substitutions_approverIdTousers", fields: [approverId], references: [id])
  users_substitutions_requesterIdTousers  users              @relation("substitutions_requesterIdTousers", fields: [requesterId], references: [id], onDelete: Cascade)
  shifts                                  shifts             @relation(fields: [shiftId], references: [id], onDelete: Cascade)
  users_substitutions_substituteIdTousers users?             @relation("substitutions_substituteIdTousers", fields: [substituteId], references: [id])
}

model user_roles {
  id     String @id
  userId String
  role   Role
  users  users  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, role])
}

model user_transports {
  id        String        @id
  userId    String
  transport TransportType
  users     users         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, transport])
}

model users {
  id                                              String            @id
  username                                        String            @unique
  password                                        String
  isFirstLogin                                    Boolean           @default(true)
  isActive                                        Boolean           @default(true)
  primaryRole                                     Role?
  primaryTransport                                TransportType?
  createdAt                                       DateTime          @default(now())
  updatedAt                                       DateTime
  phoneNumber                                     String?
  whatsappNotificationsEnabled                    Boolean           @default(true)
  trackHours                                      Boolean           @default(true)
  Account                                         Account[]
  Session                                         Session[]
  absences_absences_approvedByTousers             absences[]        @relation("absences_approvedByTousers")
  absences_absences_userIdTousers                 absences[]        @relation("absences_userIdTousers")
  advances                                        advances[]
  audit_logs                                      audit_logs[]
  availabilities                                  availabilities[]
  shifts                                          shifts[]
  substitutions_substitutions_approverIdTousers   substitutions[]   @relation("substitutions_approverIdTousers")
  substitutions_substitutions_requesterIdTousers  substitutions[]   @relation("substitutions_requesterIdTousers")
  substitutions_substitutions_substituteIdTousers substitutions[]   @relation("substitutions_substituteIdTousers")
  user_roles                                      user_roles[]
  user_transports                                 user_transports[]
  worked_hours                                    worked_hours[]
}

model worked_hours {
  id              String      @id
  shiftId         String      @unique
  userId          String
  startTime       String
  endTime         String
  totalHours      Float
  status          HoursStatus @default(PENDING)
  rejectionReason String?
  submittedAt     DateTime    @default(now())
  reviewedAt      DateTime?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime
  shifts          shifts      @relation(fields: [shiftId], references: [id], onDelete: Cascade)
  users           users       @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model holidays {
  id          String       @id
  date        DateTime
  closureType ClosureType
  description String?
  createdBy   String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime

  @@unique([date, closureType])
  @@index([date])
}

enum AuditActionType {
  SCHEDULE_GENERATE
  SCHEDULE_DELETE
  SHIFT_ADD
  SHIFT_DELETE
  SHIFT_EDIT
  USER_CREATE
  USER_DELETE
  USER_EDIT
  HOURS_APPROVE
  HOURS_REJECT
  HOURS_EDIT
  ABSENCE_CREATE
  ABSENCE_DELETE
  ABSENCE_EDIT
  SUBSTITUTION_APPROVE
  SUBSTITUTION_REJECT
  DATABASE_RESET
  DATABASE_BACKUP
  SETTINGS_CHANGE
  HOLIDAY_CREATE
  HOLIDAY_DELETE
  HOLIDAY_EDIT
}

enum ClosureType {
  FULL_DAY
  PRANZO_ONLY
  CENA_ONLY
}

enum HoursStatus {
  PENDING
  APPROVED
  REJECTED
}

enum Role {
  ADMIN
  FATTORINO
  CUCINA
  SALA
  PIZZAIOLO
}

enum ShiftStatus {
  ASSIGNED
  COMPLETED
  SUBSTITUTION_REQUESTED
  SUBSTITUTED
}

enum ShiftType {
  PRANZO
  CENA
}

enum SubstitutionStatus {
  PENDING
  APPLIED
  APPROVED
  REJECTED
  EXPIRED
  CANCELLED
}

enum TransportType {
  AUTO
  SCOOTER
}
